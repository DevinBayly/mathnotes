var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function i(e){return"function"==typeof e}function l(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let s;function a(e){s=e}const r=[],c=[],d=[],h=[],u=Promise.resolve();let p=!1;function m(e){d.push(e)}let f=!1;const g=new Set;function v(){if(!f){f=!0;do{for(let e=0;e<r.length;e+=1){const t=r[e];a(t),y(t.$$)}for(r.length=0;c.length;)c.pop()();for(let e=0;e<d.length;e+=1){const t=d[e];g.has(t)||(g.add(t),t())}d.length=0}while(r.length);for(;h.length;)h.pop()();p=!1,f=!1,g.clear()}}function y(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(m)}}const b=new Set;function w(e,t){-1===e.$$.dirty[0]&&(r.push(e),p||(p=!0,u.then(v)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function x(l,r,c,d,h,u,p=[-1]){const f=s;a(l);const g=r.props||{},y=l.$$={fragment:null,ctx:null,props:u,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(f?f.$$.context:[]),callbacks:n(),dirty:p};let x=!1;var S,E;y.ctx=c?c(l,g,(e,t,...n)=>{const o=n.length?n[0]:t;return y.ctx&&h(y.ctx[e],y.ctx[e]=o)&&(y.bound[e]&&y.bound[e](o),x&&w(l,e)),t}):[],y.update(),x=!0,o(y.before_update),y.fragment=!!d&&d(y.ctx),r.target&&(r.hydrate?y.fragment&&y.fragment.l(function(e){return Array.from(e.childNodes)}(r.target)):y.fragment&&y.fragment.c(),r.intro&&((S=l.$$.fragment)&&S.i&&(b.delete(S),S.i(E))),function(e,n,l){const{fragment:s,on_mount:a,on_destroy:r,after_update:c}=e.$$;s&&s.m(n,l),m(()=>{const n=a.map(t).filter(i);r?r.push(...n):o(n),e.$$.on_mount=[]}),c.forEach(m)}(l,r.target,r.anchor),v()),a(f)}var S,E,L="AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U",k=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];function $(){gapi.client.init({apiKey:L,clientId:"541857836176-ooorj15vavsg5e0h0c98jodmp5lt39js.apps.googleusercontent.com",discoveryDocs:k,scope:"https://www.googleapis.com/auth/drive"}).then((function(){gapi.auth2.getAuthInstance().isSignedIn.listen(T),T(gapi.auth2.getAuthInstance().isSignedIn.get()),S.onclick=C,E.onclick=j}),(function(e){I(JSON.stringify(e,null,2))}))}function T(e){e?(S.style.display="none",E.style.display="block",gapi.client.drive.files.list({pageSize:10,fields:"nextPageToken, files(id, name)"}).then((function(e){I("Files:");var t=e.result.files;if(t&&t.length>0)for(var n=0;n<t.length;n++){var o=t[n];I(o.name+" ("+o.id+")"),"notes.json"==o.name&&(D=o.id)}else I("No files found.")}))):(S.style.display="block",E.style.display="none")}function C(e){gapi.auth2.getAuthInstance().signIn()}function j(e){gapi.auth2.getAuthInstance().signOut()}function I(e){var t=document.getElementById("content"),n=document.createTextNode(e+"\n");t.appendChild(n)}let D;let A=e=>{D?(console.log("updating"),(e=>{let t='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',n=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify(e)}\n--uploadboundary--`;fetch(`https://www.googleapis.com/upload/drive/v3/files/${D}/?uploadType=multipart&key=${L}&fields=id`,{method:"PATCH",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(t+n).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:t+n}).then(e=>e.json()).then(e=>console.log(e))})(e)):(console.log("creating anew"),(()=>{let e='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',t=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify({starting:"text"})}\n--uploadboundary--\n    `;fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&api=${L}&fields=id`,{method:"POST",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(e+t).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:e+t}).then(e=>e.json()).then(e=>console.log(e))})())};function P(t){let n;return{c(){var e;e="div",n=document.createElement(e),n.innerHTML='<p>Drive API Quickstart</p> \n    <button id="authorize_button" style="display: none;">Authorize</button> \n    <button id="signout_button" style="display: none;">Sign Out</button> \n\n    <pre id="content" style="white-space: pre-wrap;"></pre> \n    <div id="pdfcontainer"><canvas id="the-canvas"></canvas></div> \n    <canvas id="canvas"></canvas>'},m(e,t){!function(e,t,n){e.insertBefore(t,n||null)}(e,n,t)},p:e,i:e,o:e,d(e){var t;e&&(t=n).parentNode.removeChild(t)}}}let _=[];class O{constructor(e,t=""){let[n,o]=e;this.element=document.createElement("textarea"),this.element.style.position="absolute",this.element.style.left=n+"px",this.element.style.top=o+"px",this.element.value=t,this.element.style.width="200px",this.element.style.height="200px"}init(){document.body.append(this.element),this.element.focus(),this.element.selectionEnd+=2,this.keyactions()}mouseup(e){let t=this.func;document.body.removeEventListener("mousemove",t)}mousedown(e){console.log("down ");let t=this.element.getBoundingClientRect();if(e.pageX-(t.left+window.scrollX)<t.width/2){this.startx=e.pageX,this.starty=e.pageY,console.log("down ",this.startx,this.starty);let t=e=>{this.mousemove(e)};document.body.addEventListener("mousemove",t),this.func=t}}mousemove(e){let t=e.pageX,n=e.pageY,o=t-this.startx,i=n-this.starty;this.startx=t,this.starty=n,this.element.style.left=`${parseFloat(this.element.style.left)+o}px`,this.element.style.top=`${parseFloat(this.element.style.top)+i}px`}keyactions(){this.element.addEventListener("mousedown",this.mousedown.bind(this)),this.element.addEventListener("mouseup",this.mouseup.bind(this)),this.element.addEventListener("keydown",e=>{if("ArrowUp"==e.key&&this.imageob.shiftup(),"ArrowDown"==e.key&&this.imageob.shiftdown(),"ArrowRight"==e.key&&(this.pdfob.page+=1,this.pdfob.loadPage(this.pdfob.page)),"ArrowLeft"==e.key&&(this.pdfob.page-=1,this.pdfob.loadPage(this.pdfob.page)),"Enter"==e.key){let t=this.element.selectionStart,n=this.element.value.slice(0,t).split("\n").slice(-1)[0],o=/^\s*/.exec(n)[0];this.element.value=this.element.value.slice(0,t)+"\n"+o+this.element.value.slice(t),this.element.selectionStart=t+1+o.length,this.element.selectionEnd=this.element.selectionStart,e.preventDefault()}if("Control"==e.key&&(this.control=!0),"Alt"==e.key&&(e.preventDefault(),this.check()),"Tab"==e.key){e.preventDefault();let t=this.element.selectionStart;this.element.value=this.element.value.slice(0,t)+"  "+this.element.value.slice(t),this.element.selectionStart=t+2,this.element.selectionEnd=t+2}e.key}),this.element.addEventListener("keyup",e=>{"Control"==e.key&&(this.control=!1)})}calcHeight(){let e=Math.max(...this.element.value.split("\n").map(e=>e.length));this.element.style.width=`${8*e+30>150?150:8*e+30}px`,this.element.style.height=`${this.element.scrollHeight}px`}check(){if(console.log("checking"),/-write-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-write-/,""),fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-savefile-",contents:this.filename+"\n"+this.element.value})})),/-file-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-file-/,""),this.filename=this.element.value,fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-file-",contents:this.element.value})}).then(e=>e.text()).then(e=>{this.element.value=e})),/-loadimg .* -/.exec(this.element.value)){let e=this.element.value.match(/-loadimg (.*) -/)[1];this.imageob=(()=>{let e={ep:null,create:t=>{let n=new Image;n.src=t,n.onload=()=>{e.holder=document.querySelector("#pdfcontainer"),e.holder.style.overflow="scroll",e.holder.style.height="500px",e.holder.append(n)}},page:0,shiftup:()=>{e.page-=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()},shiftdown:()=>{e.page+=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()}};return e})(),this.imageob.create(e);let t=()=>{let e=this.element.value.split("\n");/-top/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-top${this.imageob.topCalc}-`;let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-t.getBoundingClientRect().width}px`};this.imageob.ep=t}if(/-loadpdf.* -/.exec(this.element.value)){let e=this.element.value.match(/-loadpdf(.*?) -/)[1];this.element.value=this.element.value.replace(/-loadpdf.*? -/,e),(async()=>{let e={};return e.ep=null,e.create=async t=>{let n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.3.200/build/pdf.min.js",document.body.append(n),e.pdfData=await fetch(`https://www.googleapis.com/drive/v3/files/${t}/?key=AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U&alt=media`).then(e=>e.arrayBuffer()),e.pdfjsLib=window["pdfjs-dist/build/pdf"],e.pdfjsLib.disableWorker=!0,e.pdf=e.pdfjsLib.getDocument({data:e.pdfData}).promise,e.holder=document.querySelector("#pdfcontainer");let o=document.createElement("button");o.innerHTML="left",o.style.position="relative",o.style.left="0px",o.style.bottom="0px",o.addEventListener("click",()=>{e.page-=1,e.loadPage(e.page)});let i=document.createElement("button");i.style.position="relative",i.style.right="0px",i.style.bottom="0px",i.innerHTML="right",i.addEventListener("click",()=>{e.page+=1,e.loadPage(e.page)}),e.holder.append(o),e.holder.append(i)},e.loadPage=t=>{e.page=parseInt(t),e.pdf.then(n=>{console.log("PDF loaded"),n.getPage(parseInt(t)).then((function(t){console.log("Page loaded");var n=t.getViewport({scale:1}),o=document.getElementById("the-canvas"),i=o.getContext("2d");o.height=n.height,o.width=n.width;var l={canvasContext:i,viewport:n};t.render(l).promise.then((function(){console.log("Page rendered")})),e.ep()}))})},e})().then(t=>{this.pdfob=t,this.pdfob.create(e);this.pdfob.ep=()=>{let e=this.element.value.split("\n");/-page/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-page${this.pdfob.page}-`};let n=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-n.getBoundingClientRect().width}px`,document.querySelector("#pdfcontainer").style.top=`${parseFloat(this.element.style.top)-n.getBoundingClientRect().height}px`})}if(/-page\d+-/.exec(this.element.value.slice(this.element.startSelection,this.element.endSelection))){let e=this.element.value.slice(this.element.startSelection,this.element.endSelection).match(/-page(\d+)-/)[1];this.pdfob.loadPage(e);let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-t.getBoundingClientRect().width}px`}if(/-start-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-start-/,"-running-"),this.begin=new Date,this.timeout=setTimeout(()=>{new Notification("20 mins passed")},12e5)),/-stop-/.exec(this.element.value)){this.end=new Date,this.element.value=this.element.value.replace(/-stop-/,"");let e=`${(new Date).toUTCString()}: ${((this.end.getTime()-this.begin.getTime())/6e4).toFixed(3)}`;this.element.value=this.element.value.replace(/-running-/,e);this.element.selectionStart;clearTimeout(this.timeout)}if(/-tex-/.exec(this.element.value)){let e=this.element;fetch("http://localhost:8040/",{method:"POST",body:JSON.stringify({operation:"-latex-",contents:this.element.value.replace(/-tex-/,"")})}).then(t=>{let n=new Image;n.onload=()=>{let t=e.getBoundingClientRect();document.querySelector("canvas").getContext("2d").drawImage(n,t.x+t.width,t.y+t.height)},fetch("./image.png").then(e=>e.blob()).then(e=>{n.src=URL.createObjectURL(e)})})}/-date-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-date-/,""),fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-date-",contents:this.element.value})}).then(e=>e.text()).then(e=>{this.element.value=e}))}timer(){this.timer=setInterval(()=>{this.check()},1e4)}}class q{constructor(){let e=document.querySelector("#canvas"),t=new Image;t.onload=()=>{let n=e.getContext("2d");e.width=t.width,e.height=t.height,n.drawImage(t,0,0)},fetch(`https://www.googleapis.com/drive/v3/files/${D}/?key=${L}&alt=media`).then(e=>e.json()).then(e=>{t.src=JSON.parse(e).canvas_data})}}class B{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="load all",this.btn.addEventListener("click",()=>{this.load()})}load(){fetch("/all").then(e=>e.json()).then(e=>{this.select=document.createElement("select");for(let t of e){let e=document.createElement("option");e.value=`${t.id}`,e.innerHTML=`${t.size},${t.ctime}`,this.select.append(e)}document.body.prepend(this.select),this.select.onchange=()=>{this.select.value;fetch("/idfetch",{method:"POST",headers:{"Content-Type":"text/plain","Content-Length":this.select.value.length},body:this.select.value}).then(e=>e.json()).then(e=>{e.map(e=>{new O([Math.abs(e.x),Math.abs(e.y)],e.value).init()})})}})}}class N{constructor(){this.btn=document.createElement("button"),document.body.prepend(this.btn),this.btn.addEventListener("click",()=>{this.load()}),this.btn.id="reload",this.btn.innerHTML="Load prev data"}load(){new q}}class R{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="Download",this.btn.id="download",this.btn.addEventListener("click",()=>{this.retrieveInfo();let e=document.querySelector("#canvas").toDataURL();A(JSON.stringify({canvas_data:e}))}),document.body.prepend(this.btn)}retrieveInfo(){return Array(...document.querySelectorAll("textarea")).map(e=>{let t=e.getBoundingClientRect();return{x:t.x+window.scrollX,y:t.y+window.scrollY,value:e.value}})}}const X=new class extends class{$destroy(){!function(e,t){const n=e.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}}{constructor(e){super(),x(this,e,null,P,l,{})}}({target:document.body,props:{name:"world"}});return window.onload=()=>{S=document.getElementById("authorize_button"),E=document.getElementById("signout_button"),gapi.load("client:auth2",$),(()=>{Notification.requestPermission();let e=document.querySelector("#canvas");e.width=8e3,e.height=8e3;let t=e.getContext("2d"),n=t.lineWidth,o=(new R,new N,new B,!1),i=()=>{let n=t.getImageData(0,0,e.width,e.height);e.width+=500,e.height+=500,t.fillStyle="white",t.fillRect(0,0,e.width,e.height),t.putImageData(n,0,0)};document.body.addEventListener("touchstart",(function(e){e.preventDefault()}),{passive:!1}),document.body.addEventListener("touchmove",(function(e){e.preventDefault()}),{passive:!1}),document.body.addEventListener("touchend",(function(e){e.preventDefault()}),{passive:!1}),document.body.addEventListener("touchcancel",(function(e){e.preventDefault()}),{passive:!1});let l=!1,s=[0,0];document.body.addEventListener("keydown",a=>{let r={scrollx:window.scrollX,scrolly:window.scrollY},c=e=>{e.touches&&(e=e.changedTouches[0]),null==r.initialx&&(r.initialx=e.clientX,r.initialy=e.clientY),window.scrollTo(r.scrollx+2*(r.initialx-e.clientX),r.scrolly+4*(r.initialy-e.clientY))};if("Shift"==a.key&&(e.addEventListener("mousemove",c),e.addEventListener("touchmove",c)),"p"==a.key&&l){let e=new Image;e.onload=()=>{t.drawImage(e,s[0],s[1])},fetch("./image.png").then(e=>e.blob()).then(t=>{e.src=URL.createObjectURL(t)})}if("e"==a.key&&(o=!o,l&&o?(t.lineWidth=20,t.strokeStyle="white"):(t.lineWidth=n,t.strokeStyle="black")),"N"==a.key&&l){l=!1,new O(s).init(),a.preventDefault()}let d=t=>{"Shift"==t.key&&(e.removeEventListener("mousemove",c),e.removeEventListener("touchmove",c),e.removeEventListener("keyup",d),(window.scrollX+50>window.scrollMaxX||window.scrollY+50>window.scrollMaxY)&&i())};document.body.addEventListener("keyup",d)});let a=e=>{if(e.touches){e.preventDefault();for(let t of e.changedTouches)s[0]=t.pageX,s[1]=t.pageY}else s[0]=e.pageX,s[1]=e.pageY},r=[],c=n=>{if(n.shiftKey)return;e.removeEventListener("mousemove",a),e.removeEventListener("touchmove",a),l=!0;let o,s,c=e.getBoundingClientRect();if(n.touches){n.preventDefault();for(let e of n.changedTouches)o=e.clientX-c.left,s=e.clientY-c.top}else o=n.clientX-c.left,s=n.clientY-c.top;let d=t=>{let n,o,l=e.getBoundingClientRect();if(t.touches){t.preventDefault();for(let e of t.changedTouches)n=e.clientX-l.left,o=e.clientY-l.top}else n=t.clientX-l.left,o=t.clientY-l.top;r.push(Math.round(n)),r.push(Math.round(o)),(n+50>e.width||o+50>e.height)&&i()};r.push(Math.round(o)),r.push(Math.round(s)),e.addEventListener("mousemove",d),e.addEventListener("touchmove",d);let h=n=>{t.moveTo(r[0],r[1]),t.beginPath();for(let e=2;e<r.length;e+=2)t.lineTo(r[e],r[e+1]);t.stroke(),_=_.concat(r),_.push(0),r=[],e.removeEventListener("mousemove",d),e.removeEventListener("mouseup",h),e.removeEventListener("touchmove",d),e.removeEventListener("touchend",h),e.addEventListener("mousemove",a),e.addEventListener("touchmove",a)};e.addEventListener("mouseup",h),e.addEventListener("touchend",h)};e.addEventListener("mousedown",c),e.addEventListener("touchstart",c),document.querySelector("#reload").click()})()},X}();
//# sourceMappingURL=bundle.js.map
