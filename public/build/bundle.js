var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function l(e){return"function"==typeof e}function i(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let a;function s(e){a=e}const r=[],c=[],d=[],h=[],u=Promise.resolve();let p=!1;function m(e){d.push(e)}let g=!1;const f=new Set;function y(){if(!g){g=!0;do{for(let e=0;e<r.length;e+=1){const t=r[e];s(t),v(t.$$)}for(r.length=0;c.length;)c.pop()();for(let e=0;e<d.length;e+=1){const t=d[e];f.has(t)||(f.add(t),t())}d.length=0}while(r.length);for(;h.length;)h.pop()();p=!1,g=!1,f.clear()}}function v(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(m)}}const b=new Set;function w(e,t){-1===e.$$.dirty[0]&&(r.push(e),p||(p=!0,u.then(y)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function x(i,r,c,d,h,u,p=[-1]){const g=a;s(i);const f=r.props||{},v=i.$$={fragment:null,ctx:null,props:u,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(g?g.$$.context:[]),callbacks:n(),dirty:p};let x=!1;var S,k;v.ctx=c?c(i,f,(e,t,...n)=>{const o=n.length?n[0]:t;return v.ctx&&h(v.ctx[e],v.ctx[e]=o)&&(v.bound[e]&&v.bound[e](o),x&&w(i,e)),t}):[],v.update(),x=!0,o(v.before_update),v.fragment=!!d&&d(v.ctx),r.target&&(r.hydrate?v.fragment&&v.fragment.l(function(e){return Array.from(e.childNodes)}(r.target)):v.fragment&&v.fragment.c(),r.intro&&((S=i.$$.fragment)&&S.i&&(b.delete(S),S.i(k))),function(e,n,i){const{fragment:a,on_mount:s,on_destroy:r,after_update:c}=e.$$;a&&a.m(n,i),m(()=>{const n=s.map(t).filter(l);r?r.push(...n):o(n),e.$$.on_mount=[]}),c.forEach(m)}(i,r.target,r.anchor),y()),s(g)}var S,k,$="AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U",E=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];function L(){gapi.client.init({apiKey:$,clientId:"541857836176-ooorj15vavsg5e0h0c98jodmp5lt39js.apps.googleusercontent.com",discoveryDocs:E,scope:"https://www.googleapis.com/auth/drive"}).then((function(){gapi.auth2.getAuthInstance().isSignedIn.listen(C),C(gapi.auth2.getAuthInstance().isSignedIn.get()),S.onclick=T,k.onclick=j}),(function(e){I(JSON.stringify(e,null,2))}))}function C(e){e?(S.style.display="none",k.style.display="block",gapi.client.drive.files.list({pageSize:10,fields:"nextPageToken, files(id, name)"}).then((function(e){I("Files:");var t=e.result.files;if(t&&t.length>0)for(var n=0;n<t.length;n++){var o=t[n];I(o.name+" ("+o.id+")"),"notes.json"==o.name&&(A=o.id)}else I("No files found.")}))):(S.style.display="block",k.style.display="none")}function T(e){gapi.auth2.getAuthInstance().signIn()}function j(e){gapi.auth2.getAuthInstance().signOut()}function I(e){var t=document.getElementById("content"),n=document.createTextNode(e+"\n");t.appendChild(n)}let A;let D=e=>{A?(console.log("updating"),(e=>{let t='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',n=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify(e)}\n--uploadboundary--`;fetch(`https://www.googleapis.com/upload/drive/v3/files/${A}/?uploadType=multipart&key=${$}&fields=id`,{method:"PATCH",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(t+n).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:t+n}).then(e=>e.json()).then(e=>console.log(e))})(e)):(console.log("creating anew"),(()=>{let e='--uploadboundary\nContent-Disposition:form-data;name="metadata";filename="first"\nContent-Type: application/json; charset=UTF-8\n\n{"name":"notes.json","mimeType":"application/json"}\n',t=`--uploadboundary\nContent-Disposition:form-data;name="file";filename="blob"\nContent-Type: application/json\n\n${JSON.stringify({starting:"text"})}\n--uploadboundary--\n    `;fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&api=${$}&fields=id`,{method:"POST",headers:{"Content-type":"multipart/related; boundary=uploadboundary","Content-Length":(e+t).length,Authorization:"Bearer "+gapi.auth.getToken().access_token},body:e+t}).then(e=>e.json()).then(e=>console.log(e))})())};function P(t){let n;return{c(){var e;e="div",n=document.createElement(e),n.innerHTML='<p>Drive API Quickstart</p> \n    <button id="authorize_button" style="display: none;">Authorize</button> \n    <button id="signout_button" style="display: none;">Sign Out</button> \n\n    <pre id="content" style="white-space: pre-wrap;"></pre> \n    <div id="pdfcontainer"><canvas id="the-canvas"></canvas></div> \n    <canvas id="canvas"></canvas>'},m(e,t){!function(e,t,n){e.insertBefore(t,n||null)}(e,n,t)},p:e,i:e,o:e,d(e){var t;e&&(t=n).parentNode.removeChild(t)}}}let _=[];class O{constructor(e,t=""){let[n,o]=e;this.element=document.createElement("textarea"),this.element.style.position="absolute",this.element.style.left=n+"px",this.element.style.top=o+"px",this.element.value=t,this.element.style.width="200px",this.element.style.height="200px"}init(){document.body.append(this.element),this.element.focus(),this.element.selectionEnd+=2,this.keyactions()}mouseup(e){let t=this.func;document.body.removeEventListener("mousemove",t)}mousedown(e){console.log("down ");let t=this.element.getBoundingClientRect();if(e.pageX-(t.left+window.scrollX)<t.width/2){this.startx=e.pageX,this.starty=e.pageY,console.log("down ",this.startx,this.starty);let t=e=>{this.mousemove(e)};document.body.addEventListener("mousemove",t),this.func=t}}mousemove(e){let t=e.pageX,n=e.pageY,o=t-this.startx,l=n-this.starty;this.startx=t,this.starty=n,this.element.style.left=`${parseFloat(this.element.style.left)+o}px`,this.element.style.top=`${parseFloat(this.element.style.top)+l}px`}keyactions(){this.element.addEventListener("mousedown",this.mousedown.bind(this)),this.element.addEventListener("mouseup",this.mouseup.bind(this)),this.element.addEventListener("keydown",e=>{if("ArrowUp"==e.key&&this.imageob.shiftup(),"ArrowDown"==e.key&&this.imageob.shiftdown(),"ArrowRight"==e.key&&(this.pdfob.page+=1,this.pdfob.loadPage(this.pdfob.page)),"ArrowLeft"==e.key&&(this.pdfob.page-=1,this.pdfob.loadPage(this.pdfob.page)),"Enter"==e.key){let t=this.element.selectionStart,n=this.element.value.slice(0,t).split("\n").slice(-1)[0],o=/^\s*/.exec(n)[0];this.element.value=this.element.value.slice(0,t)+"\n"+o+this.element.value.slice(t),this.element.selectionStart=t+1+o.length,this.element.selectionEnd=this.element.selectionStart,e.preventDefault()}if("Control"==e.key&&(this.control=!0),"Alt"==e.key&&(e.preventDefault(),this.check()),"Tab"==e.key){e.preventDefault();let t=this.element.selectionStart;this.element.value=this.element.value.slice(0,t)+"  "+this.element.value.slice(t),this.element.selectionStart=t+2,this.element.selectionEnd=t+2}e.key}),this.element.addEventListener("keyup",e=>{"Control"==e.key&&(this.control=!1)})}calcHeight(){let e=Math.max(...this.element.value.split("\n").map(e=>e.length));this.element.style.width=`${8*e+30>150?150:8*e+30}px`,this.element.style.height=`${this.element.scrollHeight}px`}check(){if(console.log("checking"),/-write-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-write-/,""),fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-savefile-",contents:this.filename+"\n"+this.element.value})})),/-file-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-file-/,""),this.filename=this.element.value,fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-file-",contents:this.element.value})}).then(e=>e.text()).then(e=>{this.element.value=e})),/-loadimg .* -/.exec(this.element.value)){let e=this.element.value.match(/-loadimg (.*) -/)[1];this.imageob=(()=>{let e={ep:null,create:t=>{let n=new Image;n.src=t,n.onload=()=>{e.holder=document.querySelector("#pdfcontainer"),e.holder.style.overflow="scroll",e.holder.style.height="500px",e.holder.append(n)}},page:0,shiftup:()=>{e.page-=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()},shiftdown:()=>{e.page+=1,e.topCalc=e.holder.getBoundingClientRect().height*e.page,e.holder.scrollTop=e.topCalc,e.ep()}};return e})(),this.imageob.create(e);let t=()=>{let e=this.element.value.split("\n");/-top/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-top${this.imageob.topCalc}-`;let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-t.getBoundingClientRect().width}px`};this.imageob.ep=t}if(/-loadpdf.* -/.exec(this.element.value)){let e=this.element.value.match(/-loadpdf(.*?) -/)[1];this.element.value=this.element.value.replace(/-loadpdf.*? -/,e),(async()=>{let e={};return e.ep=null,e.create=async t=>{let n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.3.200/build/pdf.min.js",document.body.append(n),e.pdfData=await fetch(`https://www.googleapis.com/drive/v3/files/${t}/?key=AIzaSyAIYCyk2KaSfTyX67jJuNKYo-AZAtwwZ-U&alt=media`).then(e=>e.arrayBuffer()),e.pdfjsLib=window["pdfjs-dist/build/pdf"],e.pdfjsLib.disableWorker=!0,e.pdf=e.pdfjsLib.getDocument({data:e.pdfData}).promise,e.holder=document.querySelector("#pdfcontainer");let o=document.createElement("button");o.innerHTML="left",o.style.position="relative",o.style.left="0px",o.style.bottom="0px",o.addEventListener("click",()=>{e.page-=1,e.loadPage(e.page)});let l=document.createElement("button");l.style.position="relative",l.style.right="0px",l.style.bottom="0px",l.innerHTML="right",l.addEventListener("click",()=>{e.page+=1,e.loadPage(e.page)}),e.holder.append(o),e.holder.append(l)},e.loadPage=t=>{e.page=parseInt(t),e.pdf.then(n=>{console.log("PDF loaded"),n.getPage(parseInt(t)).then((function(t){console.log("Page loaded");var n=t.getViewport({scale:1}),o=document.getElementById("the-canvas"),l=o.getContext("2d");o.height=n.height,o.width=n.width;var i={canvasContext:l,viewport:n};t.render(i).promise.then((function(){console.log("Page rendered")})),e.ep()}))})},e})().then(t=>{this.pdfob=t,this.pdfob.create(e);this.pdfob.ep=()=>{let e=this.element.value.split("\n");/-page/.exec(e.slice(-1)[0])&&(e.pop(),this.element.value=e.join("\n")),this.element.value+=`\n-page${this.pdfob.page}-`};let n=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-n.getBoundingClientRect().width}px`,document.querySelector("#pdfcontainer").style.top=`${parseFloat(this.element.style.top)-n.getBoundingClientRect().height}px`})}if(/-page\d+-/.exec(this.element.value.slice(this.element.startSelection,this.element.endSelection))){let e=this.element.value.slice(this.element.startSelection,this.element.endSelection).match(/-page(\d+)-/)[1];this.pdfob.loadPage(e);let t=document.querySelector("#pdfcontainer");document.querySelector("#pdfcontainer").style.position="absolute",document.querySelector("#pdfcontainer").style.left=`${parseFloat(this.element.style.left)-t.getBoundingClientRect().width}px`}if(/-start-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-start-/,"-running-"),this.begin=new Date,this.timeout=setTimeout(()=>{new Notification("20 mins passed")},12e5)),/-stop-/.exec(this.element.value)){this.end=new Date,this.element.value=this.element.value.replace(/-stop-/,"");let e=`${(new Date).toUTCString()}: ${((this.end.getTime()-this.begin.getTime())/6e4).toFixed(3)}`;this.element.value=this.element.value.replace(/-running-/,e);this.element.selectionStart;clearTimeout(this.timeout)}if(/-tex-/.exec(this.element.value)){let e=this.element;fetch("http://localhost:8040/",{method:"POST",body:JSON.stringify({operation:"-latex-",contents:this.element.value.replace(/-tex-/,"")})}).then(t=>{let n=new Image;n.onload=()=>{let t=e.getBoundingClientRect();document.querySelector("canvas").getContext("2d").drawImage(n,t.x+t.width,t.y+t.height)},fetch("./image.png").then(e=>e.blob()).then(e=>{n.src=URL.createObjectURL(e)})})}/-date-/.exec(this.element.value)&&(this.element.value=this.element.value.replace(/-date-/,""),fetch("http://localhost:8040",{method:"POST",body:JSON.stringify({operation:"-date-",contents:this.element.value})}).then(e=>e.text()).then(e=>{this.element.value=e}))}timer(){this.timer=setInterval(()=>{this.check()},1e4)}}class q{constructor(){let e=document.querySelector("#canvas"),t=new Image;t.onload=()=>{let n=e.getContext("2d");e.width=t.width,e.height=t.height,n.drawImage(t,0,0)},fetch(`https://www.googleapis.com/drive/v3/files/${A}/?key=${$}&alt=media`).then(e=>e.json()).then(e=>{t.src=JSON.parse(e).canvas_data})}}class B{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="load all",this.btn.addEventListener("click",()=>{this.load()})}load(){fetch("/all").then(e=>e.json()).then(e=>{this.select=document.createElement("select");for(let t of e){let e=document.createElement("option");e.value=`${t.id}`,e.innerHTML=`${t.size},${t.ctime}`,this.select.append(e)}document.body.prepend(this.select),this.select.onchange=()=>{this.select.value;fetch("/idfetch",{method:"POST",headers:{"Content-Type":"text/plain","Content-Length":this.select.value.length},body:this.select.value}).then(e=>e.json()).then(e=>{e.map(e=>{new O([Math.abs(e.x),Math.abs(e.y)],e.value).init()})})}})}}class N{constructor(){this.btn=document.createElement("button"),document.body.prepend(this.btn),this.btn.addEventListener("click",()=>{this.load()}),this.btn.id="reload",this.btn.innerHTML="Load prev data"}load(){new q}}class R{constructor(){this.btn=document.createElement("button"),this.btn.innerHTML="Download",this.btn.id="download",this.btn.addEventListener("click",()=>{this.retrieveInfo();let e=document.querySelector("#canvas").toDataURL();D(JSON.stringify({canvas_data:e}))}),document.body.prepend(this.btn)}retrieveInfo(){return Array(...document.querySelectorAll("textarea")).map(e=>{let t=e.getBoundingClientRect();return{x:t.x+window.scrollX,y:t.y+window.scrollY,value:e.value}})}}const M=new class extends class{$destroy(){!function(e,t){const n=e.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}}{constructor(e){super(),x(this,e,null,P,i,{})}}({target:document.body,props:{name:"world"}});return window.onload=()=>{S=document.getElementById("authorize_button"),k=document.getElementById("signout_button"),gapi.load("client:auth2",L),(()=>{Notification.requestPermission();let e=document.querySelector("#canvas");e.width=8e3,e.height=8e3;let t=e.getContext("2d"),n=(new R,new N,new B,()=>{let n=t.getImageData(0,0,e.width,e.height);e.width+=500,e.height+=500,t.fillStyle="white",t.fillRect(0,0,e.width,e.height),t.putImageData(n,0,0)}),o=!1,l=[0,0];document.body.addEventListener("keydown",i=>{let a={scrollx:window.scrollX,scrolly:window.scrollY},s=e=>{null==a.initialx&&(a.initialx=e.clientX,a.initialy=e.clientY),window.scrollTo(a.scrollx+2*(a.initialx-e.clientX),a.scrolly+4*(a.initialy-e.clientY))};if("Shift"==i.key&&e.addEventListener("mousemove",s),"p"==i.key&&o){let e=new Image;e.onload=()=>{t.drawImage(e,l[0],l[1])},fetch("./image.png").then(e=>e.blob()).then(t=>{e.src=URL.createObjectURL(t)})}if("N"==i.key&&o){o=!1,new O(l).init(),i.preventDefault()}let r=t=>{"Shift"==t.key&&(e.removeEventListener("mousemove",s),e.removeEventListener("keyup",r),(window.scrollX+50>window.scrollMaxX||window.scrollY+50>window.scrollMaxY)&&n())};document.body.addEventListener("keyup",r)});let i=e=>{l[0]=e.pageX,l[1]=e.pageY};e.addEventListener("mousemove",i);let a=[];e.addEventListener("mousedown",l=>{e.removeEventListener("mousemove",i),o=!0;let s=e.getBoundingClientRect(),r=l.clientX-s.left,c=l.clientY-s.topj,d=t=>{let o=e.getBoundingClientRect(),l=t.clientX-o.left,i=t.clientY-o.top;a.push(Math.round(l)),a.push(Math.round(i)),(l+50>e.width||i+50>e.height)&&n()};a.push(Math.round(r)),a.push(Math.round(c)),e.addEventListener("mousemove",d);let h=n=>{t.moveTo(a[0],a[1]),t.beginPath();for(let e=2;e<a.length;e+=2)t.lineTo(a[e],a[e+1]);t.stroke(),_=_.concat(a),_.push(0),a=[],e.removeEventListener("mousemove",d),e.removeEventListener("mouseup",h),e.addEventListener("mousemove",i)};e.addEventListener("mouseup",h)}),document.querySelector("#reload").click()})()},M}();
//# sourceMappingURL=bundle.js.map
